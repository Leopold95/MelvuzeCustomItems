package me.leopold95.melvuzecustomitems.items;

import com.github.sirblobman.combatlogx.api.object.TagReason;
import com.github.sirblobman.combatlogx.api.object.TagType;
import me.leopold95.melvuzecustomitems.CustomItems;
import me.leopold95.melvuzecustomitems.core.Keys;
import me.leopold95.melvuzecustomitems.core.RepeatingTask;
import me.leopold95.melvuzecustomitems.core.Sounds;
import me.leopold95.melvuzecustomitems.logic.Invulnerability;
import org.bukkit.Bukkit;
import org.bukkit.Color;
import org.bukkit.Particle;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.event.entity.EntityPotionEffectEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.persistence.PersistentDataType;
import org.bukkit.potion.PotionEffect;
import org.bukkit.potion.PotionEffectType;
import ru.melvuze.melvuzeitemslib.api.Item;

public class InvulnerabilityItem extends Item implements Listener {
    private Invulnerability logic;
    private CustomItems plugin;

    private final Particle.DustOptions option = new Particle.DustOptions(Color.BLACK, 2);
    private final PotionEffect absorbtion = new PotionEffect(PotionEffectType.ABSORPTION, 60, 1);

    private final String blackSkinName = getConfig().getString("black-skin-name");

    public InvulnerabilityItem(CustomItems plugin, String key) {
        super(plugin, key);
        this.plugin = plugin;
        plugin.getServer().getPluginManager().registerEvents(this, plugin);
        logic = new Invulnerability();
    }

    @Override
    public void onRightClick(PlayerInteractEvent playerInteractEvent, Player player, ItemStack itemStack) {
        int duration = getConfig().getInt("invulnerability-delay-seconds");

        player.getPersistentDataContainer().set(Keys.INVULNER_ABILITY, PersistentDataType.INTEGER, 1);
        Sounds.playTo(player, getConfig().getString("begin-sound"), getConfig().getInt("begin-sound-volume"));

        beginAnimation(player, duration);

        String type = getConfig().getString("combat-log-x-tag-type");
        String reason = getConfig().getString("combat-log-x-tag-reason");
        plugin.combatLogX.getCombatManager().tag(player, null, TagType.valueOf(type), TagReason.valueOf(reason));

        plugin.skinManager.setNewSkin(player, blackSkinName);
        player.addPotionEffect(absorbtion);

        Bukkit.getScheduler().runTaskLater(plugin, () -> {
            player.getPersistentDataContainer().remove(Keys.INVULNER_ABILITY);
            Sounds.playTo(player, getConfig().getString("end-sound"), getConfig().getInt("end-sound-volume"));
            plugin.skinManager.setOldSkin(player);
        }, getConfig().getInt("invulnerability-delay-seconds") * 20L);
    }

    @Override
    public void onLeftClick(PlayerInteractEvent playerInteractEvent, Player player, ItemStack itemStack) {

    }

    @EventHandler
    private void onPlayerGotDamage(EntityPotionEffectEvent event){
        if(!(event.getEntity() instanceof Player player))
            return;

        if(player.getPersistentDataContainer().has(Keys.INVULNER_ABILITY, PersistentDataType.INTEGER)){
            event.setCancelled(true);
        }
    }

    @EventHandler
    private void onPlayerDamagePlayer(EntityDamageByEntityEvent event){
        if(!(event.getDamager() instanceof Player damager))
            return;

        if(!(event.getEntity() instanceof Player target))
            return;


        if(target.getPersistentDataContainer().has(Keys.INVULNER_ABILITY, PersistentDataType.INTEGER)){
            event.setCancelled(true);
            damager.sendMessage("u  cant damage this entity");
        }


        if(damager.getPersistentDataContainer().has(Keys.INVULNER_ABILITY, PersistentDataType.INTEGER)){
            event.setCancelled(true);
            damager.sendMessage("u  cant ANY");
        }
    }

    private void beginAnimation(Player player, int duration){
        new RepeatingTask(plugin, 0, 1) {
            long ticksPassed;

            @Override
            public void run() {
                if(ticksPassed == duration * 20L)
                    canncel();

                player.getLocation().getWorld().spawnParticle(Particle.REDSTONE, player.getLocation(), 2, option);
                player.getLocation().getWorld().spawnParticle(Particle.REDSTONE, player.getLocation().add(0, 2, 0), 2, option);

                player.getLocation().getWorld().spawnParticle(Particle.REDSTONE, player.getLocation().add(.5, 1, .5), 2, option);
                player.getLocation().getWorld().spawnParticle(Particle.REDSTONE, player.getLocation().add(-.5, 1, -.5), 2, option);
                player.getLocation().getWorld().spawnParticle(Particle.REDSTONE, player.getLocation().add(.5, 1, -.5), 2, option);
                player.getLocation().getWorld().spawnParticle(Particle.REDSTONE, player.getLocation().add(-.5, 1, .5), 2, option);

                ticksPassed++;
            }
        };
    }

}
